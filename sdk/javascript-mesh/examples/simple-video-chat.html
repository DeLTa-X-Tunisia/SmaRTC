<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="true">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#667eea">
  <title>SmaRTC - Video Chat</title>
  <style>
    * { 
      margin: 0; 
      padding: 0; 
      box-sizing: border-box;
      -webkit-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
    }
    html, body { 
      width: 100%; 
      height: 100%; 
      overflow: hidden;
      position: fixed;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      flex-direction: column;
    }
    .container {
      flex: 1;
      display: flex;
      flex-direction: column;
      width: 100%;
      height: 100%;
      overflow: hidden;
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
    }
    h1 {
      color: white;
      text-align: center;
      margin: 12px 0;
      font-size: clamp(1.5em, 5vw, 2.5em);
      flex-shrink: 0;
    }
    .controls {
      background: white;
      padding: clamp(12px, 3vw, 20px);
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      margin: 0 12px 12px 12px;
      overflow-x: auto;
      flex-shrink: 0;
      -webkit-overflow-scrolling: touch;
    }
    .control-group {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
      min-width: max-content;
    }
    input, button, select {
      padding: clamp(8px, 2vw, 12px) clamp(12px, 3vw, 20px);
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: clamp(12px, 2.5vw, 14px);
      transition: all 0.3s;
      flex-shrink: 0;
    }
    input:focus, select:focus {
      outline: none;
      border-color: #667eea;
    }
    button {
      background: #667eea;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 600;
      -webkit-appearance: none;
      -webkit-tap-highlight-color: transparent;
      active: #5568d3;
    }
    button:active:not(:disabled) {
      background: #5568d3;
      transform: scale(0.98);
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
      opacity: 0.6;
    }
    button.danger {
      background: #ef4444;
    }
    button.danger:active:not(:disabled) {
      background: #dc2626;
    }
    .video-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
      flex: 1;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding: 0 12px;
      margin-bottom: 12px;
    }
    @media (min-width: 768px) {
      .video-grid {
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 16px;
        padding: 0 16px;
      }
    }
    @media (min-width: 1200px) {
      .video-grid {
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 20px;
      }
    }
    .video-container {
      background: #000;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      position: relative;
      aspect-ratio: 16 / 9;
      min-height: 180px;
    }
    .video-container video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      background: #000;
      display: block;
    }
    .video-label {
      position: absolute;
      bottom: 8px;
      left: 8px;
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 6px 12px;
      border-radius: 16px;
      font-size: clamp(11px, 2vw, 14px);
      font-weight: 600;
      z-index: 10;
    }
    .stats {
      position: absolute;
      top: 8px;
      right: 8px;
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-family: 'Courier New', monospace;
      z-index: 10;
      max-width: 40%;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .status {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 6px;
      animation: pulse 2s infinite;
    }
    .status.connected { background: #10b981; }
    .status.disconnected { background: #ef4444; }
    .status.connecting { background: #f59e0b; }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .info-panel {
      background: white;
      padding: 12px;
      border-radius: 8px;
      margin: 0 12px 12px 12px;
      font-size: 12px;
      max-height: 120px;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      flex-shrink: 0;
    }
    .info-panel h3 {
      margin-bottom: 8px;
      color: #667eea;
      font-size: 13px;
    }
    .peer-list {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .peer-badge {
      background: #f3f4f6;
      padding: 6px 12px;
      border-radius: 16px;
      font-size: 11px;
      display: flex;
      align-items: center;
      gap: 6px;
      flex-shrink: 0;
    }
    /* Optimizations for iPad and larger tablets */
    @media (min-width: 1024px) {
      .video-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      .controls {
        margin: 0 20px 20px 20px;
      }
      .info-panel {
        margin: 0 20px 20px 20px;
      }
    }
    /* Landscape mode optimizations */
    @media (orientation: landscape) {
      h1 {
        margin: 8px 0;
        font-size: clamp(1.2em, 3vw, 2em);
      }
      .controls {
        margin: 0 12px 8px 12px;
        padding: 8px 12px;
      }
      .info-panel {
        max-height: 80px;
        margin: 0 12px 8px 12px;
      }
    }
    /* Loading state */
    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    /* Offline indicator */
    .offline-indicator {
      background: #ef4444;
      color: white;
      padding: 8px 12px;
      text-align: center;
      font-size: 12px;
      font-weight: 600;
      z-index: 1000;
    }
    .peer-badge.relay {
      background: #fef3c7;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ðŸŽ¥ SmaRTC Simple Video Chat</h1>
    
    <div class="controls">
      <div class="control-group">
        <input 
          type="text" 
          id="serverUrl" 
          placeholder="Server URL" 
          value="http://localhost:5000"
          style="flex: 1; min-width: 200px;"
        />
        <input 
          type="text" 
          id="sessionId" 
          placeholder="Session ID (e.g., room-123)" 
          value="demo-room"
          style="flex: 1; min-width: 200px;"
        />
        <input 
          type="text" 
          id="username" 
          placeholder="Your name" 
          value=""
          style="flex: 1; min-width: 150px;"
        />
        <select id="quality">
          <option value="low">Low Quality</option>
          <option value="medium" selected>Medium Quality</option>
          <option value="high">High Quality</option>
        </select>
        <label>
          <input type="checkbox" id="enableMesh" checked /> Enable P2P Mesh
        </label>
        <label>
          <input type="checkbox" id="canRelay" /> Can Relay
        </label>
      </div>
      <div class="control-group" style="margin-top: 15px;">
        <button id="joinBtn">
          <span class="status disconnected"></span>
          Join Session
        </button>
        <button id="leaveBtn" disabled class="danger">Leave Session</button>
        <button id="toggleVideoBtn" disabled>ðŸŽ¥ Video On</button>
        <button id="toggleAudioBtn" disabled>ðŸŽ¤ Audio On</button>
      </div>
    </div>

    <div class="info-panel">
      <h3>ðŸ“Š Connection Info</h3>
      <div id="connectionInfo">Not connected</div>
      <h3 style="margin-top: 15px;">ðŸ‘¥ Peers (<span id="peerCount">0</span>)</h3>
      <div class="peer-list" id="peerList">No peers connected</div>
    </div>

    <div class="video-grid" id="videoGrid">
      <!-- Videos will be added here dynamically -->
    </div>
  </div>

  <script src="../dist/smartc-browser.js"></script>
  <script>
    const { SmaRTCClient } = window.SmaRTC;

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // MOBILE & PERFORMANCE OPTIMIZATIONS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    // Detect mobile and network conditions
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    let offlineIndicator = null;

    // Optimize for mobile
    if (isMobile) {
      // Disable hover animations and use touch-optimized UI
      document.documentElement.classList.add('mobile');
      
      // Prevent zoom on input focus
      document.addEventListener('touchmove', (e) => {
        if (e.target.matches('input, button, select')) {
          e.preventDefault();
        }
      }, { passive: false });

      // Add offline detection
      window.addEventListener('offline', () => showOfflineIndicator());
      window.addEventListener('online', () => hideOfflineIndicator());
    }

    // Performance monitoring
    const performanceMetrics = {
      connectionStart: null,
      firstStreamTime: null,
      avgLatency: 0,
      maxLatency: 0,
      minLatency: Infinity
    };

    // Add offline indicator to UI
    function showOfflineIndicator() {
      if (offlineIndicator) return;
      
      offlineIndicator = document.createElement('div');
      offlineIndicator.className = 'offline-indicator';
      offlineIndicator.textContent = 'ðŸ“¡ No internet connection';
      document.body.insertBefore(offlineIndicator, document.body.firstChild);
    }

    function hideOfflineIndicator() {
      if (offlineIndicator) {
        offlineIndicator.remove();
        offlineIndicator = null;
      }
    }

    // Adaptive quality based on network conditions
    function getAdaptiveQuality() {
      const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
      if (!connection) return 'medium'; // Default

      const effectiveType = connection.effectiveType; // 4g, 3g, 2g, slow-2g
      const downlink = connection.downlink || 0; // Mbps

      if (downlink < 1 || effectiveType === 'slow-2g' || effectiveType === '2g') {
        return 'low';
      } else if (downlink < 5 || effectiveType === '3g') {
        return 'medium';
      }
      return 'high';
    }

    // Performance logging
    function logMetric(name, value) {
      if (isMobile && performance.memory) {
        console.log(`[MOBILE] ${name}: ${value}, Mem: ${Math.round(performance.memory.usedJSHeapSize / 1048576)}MB`);
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    let client = null;
    let localStream = null;
    let isVideoEnabled = true;
    let isAudioEnabled = true;

    // DOM elements
    const joinBtn = document.getElementById('joinBtn');
    const leaveBtn = document.getElementById('leaveBtn');
    const toggleVideoBtn = document.getElementById('toggleVideoBtn');
    const toggleAudioBtn = document.getElementById('toggleAudioBtn');
    const videoGrid = document.getElementById('videoGrid');
    const connectionInfo = document.getElementById('connectionInfo');
    const peerList = document.getElementById('peerList');
    const peerCount = document.getElementById('peerCount');

    // Generate random username if empty
    const usernameInput = document.getElementById('username');
    if (!usernameInput.value) {
      usernameInput.value = `User-${Math.floor(Math.random() * 10000)}`;
    }

    // Join session
    joinBtn.addEventListener('click', async () => {
      const serverUrl = document.getElementById('serverUrl').value;
      const sessionId = document.getElementById('sessionId').value;
      const username = usernameInput.value;
      const quality = document.getElementById('quality').value;
      const enableMesh = document.getElementById('enableMesh').checked;
      const canRelay = document.getElementById('canRelay').checked;

      if (!sessionId || !username) {
        alert('Please enter session ID and username');
        return;
      }

      try {
        updateStatus('connecting');
        joinBtn.disabled = true;

        // Get local media
        localStream = await navigator.mediaDevices.getUserMedia({
          video: { width: 1280, height: 720 },
          audio: true
        });

        // Add local video
        addVideoElement('local', localStream, 'ðŸŽ¥ You (Local)');

        // Create client
        client = new SmaRTCClient({
          serverUrl,
          sessionId,
          username,
          quality,
          enableMesh,
          canRelay
        });

        // Register event handlers
        client.on('connected', () => {
          console.log('âœ… Connected to server');
          updateStatus('connected');
          leaveBtn.disabled = false;
          toggleVideoBtn.disabled = false;
          toggleAudioBtn.disabled = false;
          updateConnectionInfo();
        });

        client.on('disconnected', () => {
          console.log('ðŸ‘‹ Disconnected');
          updateStatus('disconnected');
          cleanup();
        });

        client.on('peer-joined', (peerId, username) => {
          console.log('ðŸ‘¤ Peer joined:', username || peerId);
          updatePeerList();
        });

        client.on('peer-left', (peerId) => {
          console.log('ðŸ‘‹ Peer left:', peerId);
          removeVideoElement(peerId);
          updatePeerList();
        });

        client.on('remote-stream', (peerId, stream, username) => {
          console.log('ðŸ“¹ Received stream from:', username || peerId);
          addVideoElement(peerId, stream, `ðŸ‘¤ ${username || peerId}`);
        });

        client.on('error', (error) => {
          console.error('âŒ Error:', error);
          alert(`Error: ${error.message}`);
        });

        client.on('session-info', (info) => {
          console.log('â„¹ï¸ Session info:', info);
          updateConnectionInfo(info);
        });

        // Connect
        await client.connect(localStream);

      } catch (error) {
        console.error('Failed to join:', error);
        alert(`Failed to join: ${error.message}`);
        updateStatus('disconnected');
        joinBtn.disabled = false;
      }
    });

    // Leave session
    leaveBtn.addEventListener('click', async () => {
      if (client) {
        await client.disconnect();
      }
      cleanup();
    });

    // Toggle video
    toggleVideoBtn.addEventListener('click', () => {
      if (localStream) {
        isVideoEnabled = !isVideoEnabled;
        localStream.getVideoTracks().forEach(track => {
          track.enabled = isVideoEnabled;
        });
        toggleVideoBtn.textContent = isVideoEnabled ? 'ðŸŽ¥ Video On' : 'ðŸš« Video Off';
      }
    });

    // Toggle audio
    toggleAudioBtn.addEventListener('click', () => {
      if (localStream) {
        isAudioEnabled = !isAudioEnabled;
        localStream.getAudioTracks().forEach(track => {
          track.enabled = isAudioEnabled;
        });
        toggleAudioBtn.textContent = isAudioEnabled ? 'ðŸŽ¤ Audio On' : 'ðŸ”‡ Audio Off';
      }
    });

    // Helper functions
    function updateStatus(status) {
      const statusDot = joinBtn.querySelector('.status');
      statusDot.className = `status ${status}`;
    }

    function addVideoElement(id, stream, label) {
      // Remove existing if any
      removeVideoElement(id);

      const container = document.createElement('div');
      container.className = 'video-container';
      container.id = `video-${id}`;

      const video = document.createElement('video');
      video.srcObject = stream;
      video.autoplay = true;
      video.playsInline = true;
      video.muted = (id === 'local'); // Mute local to avoid feedback

      const labelDiv = document.createElement('div');
      labelDiv.className = 'video-label';
      labelDiv.textContent = label;

      const statsDiv = document.createElement('div');
      statsDiv.className = 'stats';
      statsDiv.id = `stats-${id}`;
      statsDiv.textContent = 'ðŸ“Š Connecting...';

      container.appendChild(video);
      container.appendChild(labelDiv);
      container.appendChild(statsDiv);
      videoGrid.appendChild(container);

      // Update stats periodically (adaptive frequency for mobile)
      if (id !== 'local' && client) {
        const updateFrequency = isMobile ? 3000 : 2000; // Less frequent on mobile
        const intervalId = setInterval(async () => {
          if (!client || !document.getElementById(`video-${id}`)) {
            clearInterval(intervalId);
            return;
          }
          try {
            const stats = await client.getStats(id);
            if (stats) {
              // Format stats compactly for mobile
              const latency = stats.latency < 100 ? 'âœ“' : (stats.latency < 200 ? '~' : 'âš ');
              const formattedStats = isMobile 
                ? `${latency} ${stats.latency}ms`
                : `ðŸ“Š ${stats.latency}ms | ${stats.bitrate}kbps`;
              
              statsDiv.textContent = formattedStats;
              
              // Track metrics
              performanceMetrics.avgLatency = (performanceMetrics.avgLatency + stats.latency) / 2;
              performanceMetrics.maxLatency = Math.max(performanceMetrics.maxLatency, stats.latency);
              performanceMetrics.minLatency = Math.min(performanceMetrics.minLatency, stats.latency);
              
              logMetric('Latency', stats.latency);
            }
          } catch (e) {
            clearInterval(intervalId);
          }
        }, updateFrequency);
        
        // Store interval ID for cleanup
        container.dataset.intervalId = intervalId;
      }
    }

    function removeVideoElement(id) {
      const container = document.getElementById(`video-${id}`);
      if (container) {
        // Clear stats interval if exists
        const intervalId = container.dataset.intervalId;
        if (intervalId) {
          clearInterval(parseInt(intervalId));
        }
        container.remove();
      }
    }

    function updateConnectionInfo(info) {
      if (!client) {
        connectionInfo.textContent = 'Not connected';
        return;
      }

      const sessionInfo = client.getSessionInfo();
      if (sessionInfo) {
        connectionInfo.innerHTML = `
          <strong>Session:</strong> ${sessionInfo.sessionId}<br>
          <strong>Participants:</strong> ${sessionInfo.totalPeers}<br>
          <strong>Mesh Strategy:</strong> ${sessionInfo.meshStrategy || 'N/A'}<br>
          <strong>Direct Peers:</strong> ${client.getPeers().filter(p => !p.isRelay).length}<br>
          <strong>Via Relay:</strong> ${client.getPeers().filter(p => p.isRelay).length}
        `;
      } else {
        connectionInfo.textContent = 'Connected, waiting for session info...';
      }
    }

    function updatePeerList() {
      if (!client) {
        peerList.innerHTML = 'No peers connected';
        peerCount.textContent = '0';
        return;
      }

      const peers = client.getPeers();
      peerCount.textContent = peers.length;

      if (peers.length === 0) {
        peerList.innerHTML = 'No peers connected';
        return;
      }

      peerList.innerHTML = peers.map(peer => `
        <div class="peer-badge ${peer.isRelay ? 'relay' : ''}">
          ${peer.isRelay ? 'ðŸ”€' : 'ðŸ”—'} ${peer.peerId}
          <small>(${peer.latency}ms)</small>
        </div>
      `).join('');
    }

    function cleanup() {
      // Stop local stream
      if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
        localStream = null;
      }

      // Clear all stats intervals
      document.querySelectorAll('[id^="video-"]').forEach(container => {
        const intervalId = container.dataset.intervalId;
        if (intervalId) {
          clearInterval(parseInt(intervalId));
        }
      });

      // Clear videos
      videoGrid.innerHTML = '';

      // Reset UI
      joinBtn.disabled = false;
      leaveBtn.disabled = true;
      toggleVideoBtn.disabled = true;
      toggleAudioBtn.disabled = true;
      updateStatus('disconnected');
      connectionInfo.textContent = 'Not connected';
      peerList.innerHTML = 'No peers connected';
      peerCount.textContent = '0';

      client = null;
    }

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      if (client) {
        client.disconnect();
      }
      cleanup();
    });
  </script>
</body>
</html>
