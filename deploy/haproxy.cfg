# ===========================================
# HAProxy Configuration for Zero-Cost Scaling
# Optimized for 1M+ WebSocket connections
# ===========================================

global
    log stdout format raw local0
    maxconn 1000000
    nbthread 4
    cpu-map auto:1/1-4 0-3
    
    # Performance tuning
    tune.ssl.default-dh-param 2048
    tune.bufsize 16384
    tune.maxrewrite 1024
    
    # Memory optimization
    tune.lua.maxmem 0
    tune.pattern.cache-size 100000

defaults
    log global
    mode http
    option httplog
    option dontlognull
    option forwardfor
    option http-server-close
    
    timeout connect 5s
    timeout client 2m
    timeout server 2m
    timeout tunnel 1h
    timeout client-fin 30s
    
    # Connection optimization
    maxconn 1000000
    
    # Health checks
    option httpchk GET /health
    http-check expect status 200

# ===========================================
# Statistics page
# ===========================================
listen stats
    bind *:8404
    mode http
    stats enable
    stats uri /stats
    stats refresh 10s
    stats admin if TRUE
    stats auth admin:zerocost2024

# ===========================================
# Frontend - HTTP/WebSocket
# ===========================================
frontend http_front
    bind *:80
    mode http
    
    # Connection limits
    maxconn 1000000
    
    # Request optimization
    option http-buffer-request
    timeout http-request 10s
    
    # Routing
    acl is_websocket hdr(Upgrade) -i WebSocket
    acl is_signal_path path_beg /signalhub
    
    use_backend signal_servers if is_signal_path or is_websocket
    default_backend signal_servers

# ===========================================
# Backend - Signal Servers (Round-Robin)
# ===========================================
backend signal_servers
    mode http
    balance roundrobin
    
    # Sticky sessions for WebSocket (optional)
    # cookie SERVERID insert indirect nocache
    
    # Connection pooling
    option httpclose
    option abortonclose
    
    # Health checks
    option httpchk GET /health
    http-check expect status 200
    
    # Servers (adjust based on replicas)
    server signal1 signal-server:5000 check maxconn 100000 weight 100
    server signal2 signal-server:5000 check maxconn 100000 weight 100
    server signal3 signal-server:5000 check maxconn 100000 weight 100
    
    # Backup server
    # server backup backup-server:5000 check backup

# ===========================================
# DNS-based load balancing hint
# For completely free solution, use DNS round-robin:
# 
# smartc.example.com -> 1.2.3.4, 5.6.7.8, 9.10.11.12
# 
# Configure multiple A records in Cloudflare (free)
# ===========================================
